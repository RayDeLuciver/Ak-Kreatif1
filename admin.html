<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Walking Story Photography</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <!-- TinyMCE CDN - Using working API key -->
    <script src="https://cdn.tiny.cloud/1/6h1pwrr2zi4ne4tchyvkcm0104lb59echyx2238r8slilvh5/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        .admin-sidebar {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }
        .admin-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #000000 0%, #000000 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .table-header {
            background: #374151;
            color: white;
        }
        .photo-thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-published {
            background: #dcfce7;
            color: #166534;
        }
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        .upload-area.dragover {
            border-color: #1d4ed8;
            background: #eff6ff;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .nav-item {
            padding: 0.75rem 1rem;
            color: #d1d5db;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            margin: 0.25rem 0;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: white;
        }
        .nav-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Admin Layout -->
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="admin-sidebar w-64 p-6">
            <div class="flex items-center mb-8">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mr-3">
                    <div class="w-6 h-6 bg-gray-800 rounded-full"></div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white">WALKINGSTORY</h2>
                    <p class="text-sm text-gray-300">Admin</p>
                </div>
            </div>
            
            <nav>
                <a href="#" class="nav-item active" data-section="fotografi">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                    </svg>
                    Fotografi
                </a>
                <a href="#" class="nav-item" data-section="fotografer">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                    Fotografer
                </a>
                <a href="#" class="nav-item" data-section="slider">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                    </svg>
                    Slider
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <!-- Fotografi Section -->
            <div id="fotografi-section" class="section active">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Fotografi</h1>
                    <button class="btn-primary" onclick="showCreateForm()">
                        <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Tambah Fotografi
                    </button>
                </div>

                <!-- Photos Table -->
                <div class="admin-card overflow-hidden">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold">NO</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">THUMBNAIL</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">JUDUL</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">LOKASI</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">TAG</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">LINK</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="photos-table-body">
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm">1</td>
                                <td class="px-6 py-4">
                                    <img src="img/Tertawa saat boncengan.jpg" alt="Photo" class="photo-thumbnail">
                                </td>
                                <td class="px-6 py-4">
                                    <div class="font-medium text-gray-900">Tindakan Pencegahan Korupsi Pemerintah Daerah Diakui: KPK Beri Penghargaan Kepada Kabupaten Mahakam Ulu</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">Taman Cerdas Kalimantan Timur</td>
                                <td class="px-6 py-4">
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1">#samarinda</span>
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">#berita</span>
                                </td>
                                <td class="px-6 py-4">
                                    <button class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex space-x-2">
                                        <button class="text-blue-600 hover:text-blue-800" onclick="editPhoto(1)">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                            </svg>
                                        </button>
                                        <button class="text-red-600 hover:text-red-800" onclick="deletePhoto(1)">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zM12 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- More rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create/Edit Form -->
            <div id="create-form-section" class="section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Tambah Fotografi</h1>
                    <button class="btn-secondary" onclick="showPhotosTable()">
                        ‚Üê Kembali ke Daftar
                    </button>
                </div>

                <div class="admin-card p-8">
                    <form id="photo-form" enctype="multipart/form-data">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Judul</label>
                                    <input type="text" name="title" class="form-input" placeholder="Masukkan judul foto" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Supertext</label>
                                    <input type="text" name="supertext" class="form-input" placeholder="Teks tambahan">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Thumbnail</label>
                                    <div class="upload-area" onclick="document.getElementById('thumbnail-input').click()">
                                        <input type="file" id="thumbnail-input" name="thumbnail" accept="image/*" style="display: none;" onchange="previewImage(this, 'thumbnail-preview')">
                                        <div id="thumbnail-preview">
                                            <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <p class="text-gray-600">Klik untuk upload thumbnail</p>
                                            <p class="text-sm text-gray-400">PNG, JPG tanpa batas ukuran</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Lokasi</label>
                                    <input type="text" name="location" class="form-input" placeholder="Lokasi pengambilan foto" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Kategori</label>
                                    <input type="text" name="category" class="form-input" placeholder="Masukkan kategori foto (contoh: human-interest, culinary, social-activity)" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Fotografer</label>
                                    <input type="text" name="photographer" class="form-input" placeholder="Masukkan nama fotografer" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Hashtag</label>
                                    <input type="text" name="hashtags" class="form-input" placeholder="#samarinda #streetphoto #berita">
                                    <p class="text-sm text-gray-500 mt-1">Pisahkan dengan spasi, contoh: #tag1 #tag2</p>
                                </div>

                                <!-- Publish Online Option -->
                                <div class="form-group">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="publish-online" name="publish_online" class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="publish-online" class="form-label mb-0">
                                            <span class="font-semibold text-green-600">üåê Publish Online</span>
                                            <p class="text-sm text-gray-500 mt-1">Centang untuk membuat foto bisa dilihat orang lain secara online</p>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Berita</label>
                                    <textarea id="content-editor" name="content" rows="15" class="form-input" placeholder="Tulis konten berita di sini..."></textarea>
                                </div>

                                <!-- Upload Status -->
                                <div id="upload-status" class="form-group" style="display: none;">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h4 class="font-semibold text-blue-800 mb-2">üì§ Upload Status</h4>
                                        <div id="upload-progress" class="mb-2">
                                            <div class="bg-blue-200 rounded-full h-2">
                                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <p id="upload-message" class="text-sm text-blue-700">Preparing upload...</p>
                                    </div>
                                </div>

                                <!-- Public URL Display -->
                                <div id="public-url-display" class="form-group" style="display: none;">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 class="font-semibold text-green-800 mb-2">üîó Public Link</h4>
                                        <div class="flex items-center space-x-2">
                                            <input type="text" id="public-url" class="form-input text-sm" readonly>
                                            <button type="button" onclick="copyPublicUrl()" class="btn-secondary text-sm px-3 py-1">Copy</button>
                                        </div>
                                        <p class="text-sm text-green-700 mt-1">Link ini bisa dibagikan ke orang lain</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 mt-8">
                            <button type="button" class="btn-secondary" onclick="showPhotosTable()">Batal</button>
                            <button type="submit" class="btn-primary">Tambah</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Fotografer Section -->
            <div id="fotografer-section" class="section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Fotografer</h1>
                    <button class="btn-primary" onclick="showCreatePhotographerForm()">
                        <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Tambah Fotografer
                    </button>
                </div>

                <!-- Photographers Table -->
                <div class="admin-card overflow-hidden">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold">NAMA</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">AKSI</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm font-medium">Fahri</td>
                                <td class="px-6 py-4">
                                    <div class="flex space-x-2">
                                        <button class="text-blue-600 hover:text-blue-800">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                            </svg>
                                        </button>
                                        <button class="text-red-600 hover:text-red-800">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zM12 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm font-medium">Marvel</td>
                                <td class="px-6 py-4">
                                    <div class="flex space-x-2">
                                        <button class="text-blue-600 hover:text-blue-800">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                            </svg>
                                        </button>
                                        <button class="text-red-600 hover:text-red-800">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zM12 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm font-medium">Sultan</td>
                                <td class="px-6 py-4">
                                    <div class="flex space-x-2">
                                        <button class="text-blue-600 hover:text-blue-800">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                            </svg>
                                        </button>
                                        <button class="text-red-600 hover:text-red-800">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 0 100-2H9z" clip-rule="evenodd"/>
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zM12 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create Photographer Form -->
            <div id="create-photographer-section" class="section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Tambah Fotografer</h1>
                    <button class="btn-secondary" onclick="showPhotographersTable()">
                        ‚Üê Kembali ke Daftar
                    </button>
                </div>

                <div class="admin-card p-8">
                    <form id="photographer-form">
                        <div class="form-group">
                            <label class="form-label">Nama Fotografer</label>
                            <input type="text" name="photographer_name" class="form-input" placeholder="Masukkan nama fotografer" required>
                        </div>

                        <div class="flex justify-end space-x-4 mt-8">
                            <button type="button" class="btn-secondary" onclick="showPhotographersTable()">Batal</button>
                            <button type="submit" class="btn-primary">Tambah</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Slider Section -->
            <div id="slider-section" class="section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Slider</h1>
                </div>

                <div class="admin-card p-8">
                    <p class="text-gray-600">Slider management functionality will be implemented here.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.section');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all sections
                    sections.forEach(section => section.style.display = 'none');
                    
                    // Show selected section
                    const sectionName = this.getAttribute('data-section');
                    const targetSection = document.getElementById(sectionName + '-section');
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    }
                });
            });

            // Initialize TinyMCE with working configuration from example
            console.log('Initializing TinyMCE...');
            
            // Check if TinyMCE is loaded
            if (typeof tinymce === 'undefined') {
                console.error('TinyMCE not loaded! Check your internet connection and API key.');
                alert('TinyMCE gagal dimuat. Periksa koneksi internet Anda.');
                return;
            }

            tinymce.init({
                selector: 'textarea#content-editor',
                height: 400,
                plugins: 'image media mediaembed code lists',
                toolbar: 'undo redo | link image | media | bold italic | alignleft aligncenter alignright | bullist numlist | code',
                /* enable title field in the Image dialog*/
                image_title: true,
                /* enable automatic uploads of images represented by blob or data URIs*/
                automatic_uploads: true,
                /*
                  URL of our upload handler (for more details check: https://www.tiny.cloud/docs/configure/file-image-upload/#images_upload_url)
                  images_upload_url: 'postAcceptor.php',
                  here we add custom filepicker only to Image dialog
                */
                file_picker_types: 'image',
                /* and here's our custom image picker*/
                file_picker_callback: (cb, value, meta) => {
                    const input = document.createElement('input');
                    input.setAttribute('type', 'file');
                    input.setAttribute('accept', 'image/*');

                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];

                        const reader = new FileReader();
                        reader.addEventListener('load', () => {
                            /*
                              Note: Now we need to register the blob in TinyMCEs image blob
                              registry. In the next release this part hopefully won't be
                              necessary, as we are looking to handle it internally.
                            */
                            const id = 'blobid' + (new Date()).getTime();
                            const blobCache = tinymce.activeEditor.editorUpload.blobCache;
                            const base64 = reader.result.split(',')[1];
                            const blobInfo = blobCache.create(id, file, base64);
                            blobCache.add(blobInfo);

                            /* call the callback and populate the Title field with the file name */
                            cb(blobInfo.blobUri(), {
                                title: file.name
                            });
                        });
                        reader.readAsDataURL(file);
                    });

                    input.click();
                },
                content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }',
                branding: false,
                promotion: false,
                setup: function (editor) {
                    editor.on('init', function () {
                        console.log('TinyMCE editor berhasil diinisialisasi!');
                        // Show success message
                        const editorContainer = document.querySelector('.tox-tinymce');
                        if (editorContainer) {
                            editorContainer.style.border = '2px solid #10b981';
                            setTimeout(() => {
                                editorContainer.style.border = '';
                            }, 2000);
                        }
                    });
                    
                    editor.on('LoadContent', function () {
                        console.log('TinyMCE content loaded');
                    });
                    
                    editor.on('change', function () {
                        console.log('TinyMCE content changed');
                    });
                }
            }).then(function(editors) {
                console.log('TinyMCE editors created:', editors.length);
            }).catch(function(error) {
                console.error('TinyMCE initialization failed:', error);
                alert('TinyMCE gagal diinisialisasi: ' + error.message);
                
                // Fallback: show regular textarea
                const textarea = document.getElementById('content-editor');
                if (textarea) {
                    textarea.style.display = 'block';
                    textarea.style.height = '400px';
                    textarea.placeholder = 'TinyMCE gagal dimuat. Anda masih bisa menulis di sini...';
                }
            });

        // Form submissions
        document.getElementById('photo-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            
            // Get TinyMCE content - make sure it's properly retrieved
            let content = '';
            try {
                content = tinymce.get('content-editor').getContent();
                console.log('TinyMCE content retrieved:', content);
            } catch (error) {
                console.error('Error getting TinyMCE content:', error);
                content = formData.get('content') || '';
            }
            formData.set('content', content);
            
            // Validate required fields
            const title = formData.get('title');
            const location = formData.get('location');
            const category = formData.get('category');
            const photographer = formData.get('photographer');
            const thumbnail = formData.get('thumbnail');
            
            if (!title || !location || !category || !photographer) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            if (!thumbnail || thumbnail.size === 0) {
                alert('Mohon upload foto thumbnail!');
                return;
            }

            // File size validation removed - unlimited upload
            // No size limit validation

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(thumbnail.type)) {
                alert('Format file tidak didukung! Gunakan JPG, PNG, atau GIF.');
                return;
            }
            
            // Use the new server upload function
            submitPhotoToServer(formData);
        });

            document.getElementById('photographer-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const photographerName = formData.get('photographer_name');
                
                // Validate input
                if (!photographerName || photographerName.trim() === '') {
                    alert('Mohon masukkan nama fotografer!');
                    return;
                }
                
                // Check if photographer already exists
                if (samplePhotographers.some(p => p.name.toLowerCase() === photographerName.toLowerCase())) {
                    alert('Fotografer dengan nama tersebut sudah ada!');
                    return;
                }
                
                // Create new photographer object
                const newPhotographer = {
                    id: Date.now(),
                    name: photographerName.trim(),
                    createdAt: new Date().toISOString()
                };
                
                // Add to photographers array
                samplePhotographers.push(newPhotographer);
                
                    // Save to public localStorage
                    localStorage.setItem('walkingStoryPhotographers', JSON.stringify(samplePhotographers));
                
                
                // Update photographers table
                loadPhotographers();
                
                alert(`Fotografer "${photographerName}" berhasil ditambahkan!`);
                this.reset();
                showPhotographersTable();
            });

            // Drag and drop functionality
            const uploadAreas = document.querySelectorAll('.upload-area');
            uploadAreas.forEach(area => {
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const input = this.querySelector('input[type="file"]');
                        input.files = files;
                        previewImage(input, input.id.replace('-input', '-preview'));
                    }
                });
            });
        });

        // Navigation functions with better state management
        function showCreateForm() {
            document.getElementById('fotografi-section').style.display = 'none';
            document.getElementById('create-form-section').style.display = 'block';
            
            // Ensure TinyMCE is properly initialized when showing form
            setTimeout(() => {
                if (tinymce.get('content-editor')) {
                    tinymce.get('content-editor').focus();
                }
            }, 100);
        }

        function showPhotosTable() {
            document.getElementById('create-form-section').style.display = 'none';
            document.getElementById('fotografi-section').style.display = 'block';
            
            // Reload photos to ensure latest data is displayed
            loadPhotos();
        }

        function showCreatePhotographerForm() {
            document.getElementById('fotografer-section').style.display = 'none';
            document.getElementById('create-photographer-section').style.display = 'block';
        }

        function showPhotographersTable() {
            document.getElementById('create-photographer-section').style.display = 'none';
            document.getElementById('fotografer-section').style.display = 'block';
        }

        // Image preview function
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                        <p class="text-sm text-gray-600 mt-2">${file.name}</p>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        // Photo management functions
        function editPhoto(id) {
            // Here you would load the photo data and show the edit form
            console.log('Edit photo:', id);
            showCreateForm();
        }

        function deletePhoto(id) {
            if (confirm('Apakah Anda yakin ingin menghapus foto ini?')) {
                console.log('Delete photo:', id);
                // Here you would send delete request to server
                alert('Foto berhasil dihapus!');
            }
        }

        // User session management - simplified without login prompt
        let currentUser = 'admin';
        
        // Initialize user session - no login required
        function initializeUserSession() {
            console.log('Admin panel access granted');
            return true;
        }
        
        // Function to get user-specific localStorage key (not used anymore)
        function getUserStorageKey(baseKey) {
            return baseKey;
        }
        
        // Function to logout - redirect to main page
        function logoutUser() {
            if (confirm('Apakah Anda yakin ingin kembali ke halaman utama?')) {
                window.location.href = 'index.html';
            }
        }

        // Initialize sample photographers data
        let samplePhotographers = [
            { id: 1, name: 'Fahri', createdAt: '2024-01-01T00:00:00.000Z' },
            { id: 2, name: 'Marvel', createdAt: '2024-01-02T00:00:00.000Z' },
            { id: 3, name: 'Sultan', createdAt: '2024-01-03T00:00:00.000Z' }
        ];

        // Initialize sample data and load from localStorage
        let samplePhotos = [
            {
                id: 1,
                thumbnail: 'img/Tertawa saat boncengan.jpg',
                title: 'Tindakan Pencegahan Korupsi Pemerintah Daerah Diakui: KPK Beri Penghargaan Kepada Kabupaten Mahakam Ulu',
                location: 'Taman Cerdas Kalimantan Timur',
                category: 'human-interest',
                photographer: 'Fahri',
                tags: ['#samarinda', '#berita'],
                content: 'Berita tentang penghargaan KPK kepada Kabupaten Mahakam Ulu atas upaya pencegahan korupsi.',
                createdAt: '2024-01-01T00:00:00.000Z',
                isUploaded: false
            },
            {
                id: 2,
                thumbnail: 'img/Pedagang Jajanan Kaki Lima.jpg',
                title: 'Kehidupan Pedagang Kaki Lima di Tengah Pandemi',
                location: 'Taman Samarinda',
                category: 'culinary',
                photographer: 'Marvel',
                tags: ['#kuliner', '#streetfood'],
                content: 'Dokumentasi kehidupan pedagang kaki lima yang tetap bertahan di tengah pandemi.',
                createdAt: '2024-01-02T00:00:00.000Z',
                isUploaded: false
            },
            {
                id: 3,
                thumbnail: 'img/Kumpulan Mahasiswa sedang Menyanyikan Yel-Yel.jpg',
                title: 'Semangat Mahasiswa dalam Kegiatan Kampus',
                location: 'Islamic Center Samarinda',
                category: 'social-activity',
                photographer: 'Sultan',
                tags: ['#mahasiswa', '#aktivitas'],
                content: 'Semangat mahasiswa dalam kegiatan kampus yang penuh antusiasme.',
                createdAt: '2024-01-03T00:00:00.000Z',
                isUploaded: false
            }
        ];

        // Load photos from public localStorage on page load with better error handling
        function initializePhotos() {
            console.log('Initializing photos from public localStorage...');
            
            try {
                const savedPhotos = localStorage.getItem('walkingStoryPhotos');
                const deletedPhotos = JSON.parse(localStorage.getItem('deletedDefaultPhotos') || '[]');
                
                if (savedPhotos) {
                    const parsedPhotos = JSON.parse(savedPhotos);
                    console.log('Loaded public photos from localStorage:', parsedPhotos.length);
                    
                    // Filter only uploaded photos and merge with sample photos
                    const uploadedPhotos = parsedPhotos.filter(photo => photo.isUploaded === true);
                    console.log('Public uploaded photos found:', uploadedPhotos.length);
                    
                    // Merge uploaded photos at the beginning
                    samplePhotos = [...uploadedPhotos, ...samplePhotos];
                }
                
                // Remove deleted default photos
                if (deletedPhotos.length > 0) {
                    samplePhotos = samplePhotos.filter(photo => !deletedPhotos.includes(photo.id));
                    console.log('Filtered out deleted photos:', deletedPhotos.length);
                }
                
                console.log('Total photos after initialization:', samplePhotos.length);
            } catch (error) {
                console.error('Error loading photos from localStorage:', error);
                // Keep default sample photos if localStorage fails
            }
        }

        // Helper function to reset thumbnail preview
        function resetThumbnailPreview() {
            document.getElementById('thumbnail-preview').innerHTML = `
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="text-gray-600">Klik untuk upload thumbnail</p>
                <p class="text-sm text-gray-400">PNG, JPG tanpa batas ukuran</p>
            `;
        }

        // Enhanced photo loading function
        function loadPhotos() {
            const tbody = document.getElementById('photos-table-body');
            tbody.innerHTML = '';
            
            // Sort photos by creation date (newest first)
            const sortedPhotos = [...samplePhotos].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedPhotos.forEach((photo, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                
                // Add status indicator for uploaded photos
                const statusBadge = photo.isUploaded ? 
                    '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">Uploaded</span>' : 
                    '<span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full mr-2">Default</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm">${index + 1}</td>
                    <td class="px-6 py-4">
                        <img src="${photo.thumbnail}" alt="Photo" class="photo-thumbnail" onerror="this.src='https://via.placeholder.com/80x60?text=No+Image'">
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${photo.title}</div>
                        <div class="text-xs text-gray-500 mt-1">${statusBadge}${photo.category || 'No Category'}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${photo.location}</td>
                    <td class="px-6 py-4">
                        ${(photo.tags || []).map(tag => `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1">${tag}</span>`).join('')}
                    </td>
                    <td class="px-6 py-4">
                        <a href="index.html?photo=${photo.id}" target="_blank" class="text-blue-600 hover:text-blue-800" title="View Photo">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                        </a>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="editPhoto(${photo.id})" title="Edit Photo">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                </svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deletePhoto(${photo.id})" title="Delete Photo">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zM12 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Enhanced photo management functions
        function viewPhoto(id) {
            const photo = samplePhotos.find(p => p.id === id);
            if (photo) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-2xl max-h-[90vh] overflow-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">${photo.title}</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <img src="${photo.thumbnail}" alt="${photo.title}" class="w-full h-64 object-cover rounded-lg mb-4">
                            <div class="space-y-2">
                                <p><strong>Location:</strong> ${photo.location}</p>
                                <p><strong>Category:</strong> ${photo.category || 'N/A'}</p>
                                <p><strong>Photographer:</strong> ${photo.photographer || 'N/A'}</p>
                                <p><strong>Tags:</strong> ${(photo.tags || []).join(', ')}</p>
                                <p><strong>Created:</strong> ${new Date(photo.createdAt).toLocaleDateString()}</p>
                                ${photo.content ? `<div><strong>Content:</strong><div class="mt-2 p-3 bg-gray-50 rounded">${photo.content}</div></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function deletePhoto(id) {
            if (confirm('Apakah Anda yakin ingin menghapus foto ini?')) {
                // Find the photo to be deleted
                const photoToDelete = samplePhotos.find(photo => photo.id === id);
                
                if (photoToDelete) {
                    console.log('Deleting photo:', photoToDelete.title);
                    
                    // Remove from samplePhotos array
                    samplePhotos = samplePhotos.filter(photo => photo.id !== id);
                    
                    // Update public localStorage - handle both uploaded and default photos
                    if (photoToDelete.isUploaded) {
                        // For uploaded photos, remove from public localStorage
                        try {
                            const allStoredPhotos = JSON.parse(localStorage.getItem('walkingStoryPhotos') || '[]');
                            const updatedStoredPhotos = allStoredPhotos.filter(photo => photo.id !== id);
                            localStorage.setItem('walkingStoryPhotos', JSON.stringify(updatedStoredPhotos));
                            console.log('Uploaded photo removed from public localStorage');
                        } catch (error) {
                            console.error('Error updating localStorage:', error);
                        }
                    } else {
                        // For default photos, add to "deleted" list in localStorage
                        try {
                            let deletedPhotos = JSON.parse(localStorage.getItem('deletedDefaultPhotos') || '[]');
                            if (!deletedPhotos.includes(id)) {
                                deletedPhotos.push(id);
                                localStorage.setItem('deletedDefaultPhotos', JSON.stringify(deletedPhotos));
                                console.log('Default photo marked as deleted');
                            }
                        } catch (error) {
                            console.error('Error updating deleted photos list:', error);
                        }
                    }
                    
                    // Trigger storage event to update index.html if it's open in another tab
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'walkingStoryPhotos',
                        newValue: localStorage.getItem('walkingStoryPhotos')
                    }));
                    
                    // Reload the table
                    loadPhotos();
                    
                    alert('Foto berhasil dihapus!');
                } else {
                    alert('Foto tidak ditemukan!');
                }
            }
        }

        // Load photographers from public localStorage on page load
        function initializePhotographers() {
            const savedPhotographers = localStorage.getItem('walkingStoryPhotographers');
            if (savedPhotographers) {
                try {
                    const parsedPhotographers = JSON.parse(savedPhotographers);
                    samplePhotographers = parsedPhotographers;
                    console.log('Loaded public photographers:', parsedPhotographers.length);
                } catch (error) {
                    console.error('Error loading photographers from localStorage:', error);
                }
            }
        }

        // Function to load photographers table
        function loadPhotographers() {
            const tbody = document.querySelector('#fotografer-section tbody');
            tbody.innerHTML = '';
            
            samplePhotographers.forEach((photographer, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium">${photographer.name}</td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="editPhotographer(${photographer.id})" title="Edit Photographer">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                </svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deletePhotographer(${photographer.id})" title="Delete Photographer">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7zM12 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        // Photographer management functions
        function editPhotographer(id) {
            const photographer = samplePhotographers.find(p => p.id === id);
            if (photographer) {
                const newName = prompt('Edit nama fotografer:', photographer.name);
                if (newName && newName.trim() !== '' && newName.trim() !== photographer.name) {
                    // Check if new name already exists
                    if (samplePhotographers.some(p => p.id !== id && p.name.toLowerCase() === newName.toLowerCase())) {
                        alert('Fotografer dengan nama tersebut sudah ada!');
                        return;
                    }
                    
                    // Update photographer name
                    photographer.name = newName.trim();
                    
                    // Save to public localStorage
                    localStorage.setItem('walkingStoryPhotographers', JSON.stringify(samplePhotographers));
                    
                    // Update displays
                    loadPhotographers();
                    
                    alert(`Nama fotografer berhasil diubah menjadi "${newName.trim()}"!`);
                }
            }
        }

        function deletePhotographer(id) {
            const photographer = samplePhotographers.find(p => p.id === id);
            if (photographer) {
                if (confirm(`Apakah Anda yakin ingin menghapus fotografer "${photographer.name}"?`)) {
                    // Remove from array
                    samplePhotographers = samplePhotographers.filter(p => p.id !== id);
                    
                    // Save to public localStorage
                    localStorage.setItem('walkingStoryPhotographers', JSON.stringify(samplePhotographers));
                    
                    // Update displays
                    loadPhotographers();
                    
                    alert(`Fotografer "${photographer.name}" berhasil dihapus!`);
                }
            }
        }

        // Function to copy public URL to clipboard
        function copyPublicUrl() {
            const urlInput = document.getElementById('public-url');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                alert('Link berhasil disalin ke clipboard!');
            } catch (err) {
                console.error('Failed to copy URL:', err);
                alert('Gagal menyalin link. Silakan copy manual.');
            }
        }

        // Function to show upload progress
        function showUploadProgress() {
            document.getElementById('upload-status').style.display = 'block';
            document.getElementById('public-url-display').style.display = 'none';
        }

        // Function to update upload progress
        function updateUploadProgress(percentage, message) {
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('upload-message').textContent = message;
        }

        // Function to show public URL
        function showPublicUrl(url) {
            document.getElementById('upload-status').style.display = 'none';
            document.getElementById('public-url-display').style.display = 'block';
            document.getElementById('public-url').value = window.location.origin + '/' + url;
        }

        // Function to hide upload status
        function hideUploadStatus() {
            document.getElementById('upload-status').style.display = 'none';
            document.getElementById('public-url-display').style.display = 'none';
        }

        // Enhanced form submission with server upload
        function submitPhotoToServer(formData) {
            const publishOnline = document.getElementById('publish-online').checked;
            
            if (publishOnline) {
                // Upload to server
                showUploadProgress();
                updateUploadProgress(10, 'Mengirim foto ke server...');
                
                // Add publish_online flag to formData
                formData.set('publish_online', 'true');
                
                fetch('api/upload_photo_simple.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    updateUploadProgress(70, 'Memproses foto...');
                    
                    // Check if response is ok
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // Check if response has content
                    return response.text().then(text => {
                        if (!text) {
                            throw new Error('Empty response from server');
                        }
                        
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('Invalid JSON response:', text);
                            throw new Error('Invalid JSON response from server: ' + text.substring(0, 100));
                        }
                    });
                })
                .then(data => {
                    updateUploadProgress(100, 'Upload selesai!');
                    
                    console.log('Server response:', data);
                    
                    if (data.success) {
                        setTimeout(() => {
                            if (data.data && data.data.public_url) {
                                showPublicUrl(data.data.public_url);
                            }
                            
                            alert(`Foto "${formData.get('title')}" berhasil diupload dan dipublish online!`);
                            
                            // Reset form and reload table
                            document.getElementById('photo-form').reset();
                            try {
                                tinymce.get('content-editor').setContent('');
                            } catch (error) {
                                console.error('Error resetting TinyMCE:', error);
                            }
                            resetThumbnailPreview();
                            hideUploadStatus();
                            
                            // Reload photos from server
                            loadPhotosFromServer();
                        }, 1000);
                    } else {
                        throw new Error(data.error || 'Upload failed');
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    hideUploadStatus();
                    
                    // Show more detailed error message
                    let errorMessage = 'Error uploading foto: ';
                    if (error.message.includes('Invalid JSON')) {
                        errorMessage += 'Server response error. Please check server logs.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                });
            } else {
                // Save to localStorage only (existing functionality)
                savePhotoToLocalStorage(formData);
            }
        }

        // Function to save photo to localStorage (existing functionality)
        function savePhotoToLocalStorage(formData) {
            const thumbnail = formData.get('thumbnail');
            const timestamp = Date.now();
            const fileExtension = thumbnail.name.split('.').pop();
            const fileName = `uploaded_${timestamp}.${fileExtension}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                
                const newPhoto = {
                    id: timestamp,
                    thumbnail: base64Image,
                    fileName: fileName,
                    title: formData.get('title'),
                    location: formData.get('location'),
                    category: formData.get('category'),
                    photographer: formData.get('photographer'),
                    tags: formData.get('hashtags').split(' ').filter(tag => tag.trim() !== '').map(tag => {
                        return tag.startsWith('#') ? tag : '#' + tag;
                    }),
                    content: formData.get('content') || formData.get('supertext') || 'Dokumentasi fotografi kehidupan sehari-hari',
                    supertext: formData.get('supertext') || '',
                    createdAt: new Date().toISOString(),
                    isUploaded: true,
                    isPublished: false
                };
                
                let existingPhotos = JSON.parse(localStorage.getItem('walkingStoryPhotos') || '[]');
                existingPhotos.unshift(newPhoto);
                
                try {
                    localStorage.setItem('walkingStoryPhotos', JSON.stringify(existingPhotos));
                    console.log('Photo saved to localStorage successfully');
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    alert('Error menyimpan foto. Mungkin ada masalah dengan browser storage.');
                    return;
                }
                
                samplePhotos.unshift(newPhoto);
                loadPhotos();
                
                alert(`Foto "${formData.get('title')}" berhasil disimpan secara lokal!`);
                
                document.getElementById('photo-form').reset();
                try {
                    tinymce.get('content-editor').setContent('');
                } catch (error) {
                    console.error('Error resetting TinyMCE:', error);
                }
                resetThumbnailPreview();
                showPhotosTable();
            };
            
            reader.readAsDataURL(thumbnail);
        }

        // Function to load photos from server
        function loadPhotosFromServer() {
            fetch('api/get_photos.php')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Merge server photos with localStorage photos
                    const serverPhotos = data.photos;
                    const localPhotos = JSON.parse(localStorage.getItem('walkingStoryPhotos') || '[]')
                        .filter(photo => !photo.isPublished); // Only local photos that aren't published
                    
                    samplePhotos = [...serverPhotos, ...localPhotos, ...samplePhotos.filter(photo => !photo.isUploaded)];
                    loadPhotos();
                }
            })
            .catch(error => {
                console.error('Error loading photos from server:', error);
            });
        }

        // Initialize photos and photographers on page load with better error handling
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing admin panel...');
            
            // Initialize user session first
            if (!initializeUserSession()) {
                return; // Exit if user session failed
            }
            
            try {
                initializePhotographers();
                initializePhotos();
                loadPhotographers();
                loadPhotos();
                
                // Load photos from server if available
                loadPhotosFromServer();
                
                console.log('Admin panel initialized successfully');
            } catch (error) {
                console.error('Error initializing admin panel:', error);
            }
            
            // Add back to main page button to sidebar
            const sidebar = document.querySelector('.admin-sidebar nav');
            if (sidebar) {
                const backButton = document.createElement('a');
                backButton.href = '#';
                backButton.className = 'nav-item';
                backButton.innerHTML = `
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Kembali ke Beranda
                `;
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    logoutUser();
                });
                sidebar.appendChild(backButton);
            }
        });
    </script>
</body>
</html>